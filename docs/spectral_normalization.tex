\RequirePackage{iftex}
\RequirePDFTeX
\NeedsTeXFormat{LaTeX2e}
\documentclass[10pt]{article}
\usepackage{ismll-packages}
\usepackage{ismll-mathoperators}
\usepackage{ismll-style}
\usepackage{unicode-symbols}

\title{Derivative of the first order SVD}
\author{Randolf Scholz}
\begin{document}

\maketitle


Consider computing the first order SVD expansion. By the Eckartâ€“Youngâ€“Mirsky theorem, this is equivalent to solving


%
\begin{align*}%
\minimize_{Ïƒï¼Œuï¼Œv} Â½â€–A - Ïƒuv^âŠ¤â€–Â²_F \qq{s.t.}  â€–uâ€–=1 \qq{and} â€–vâ€–=1%
\end{align*}%
%
Any triplet $(Ïƒï¼Œuï¼Œv)$ for a \textbf{unique} singular value satisfies


\paragraph{The Jacobian and Lagrangian}
%
The derivative of the objective function is

\begin{align*}%
ğ‰_f(Aï¼Œ\bsmat{Ïƒ \\ u \\ v}) = \bmat{ A-Ïƒuv^âŠ¤ &  \mat{ Ïƒ - u^âŠ¤Av \\ ÏƒÂ²u - ÏƒAv \\ ÏƒÂ²v - ÏƒA^âŠ¤u}}
âŸ¹ ğ‡_f(\bsmat{Ïƒ \\ u \\ v}) = \bmat{ 1 & 2Ïƒu - Av & 2Ïƒv - A^âŠ¤u \\ -Av & ÏƒÂ²ğ•€â‚˜  & -ÏƒA \\ -A^âŠ¤u & -ÏƒA^âŠ¤ & ÏƒÂ²ğ•€â‚™ }
\end{align*}%
%
Consider the function
%
\begin{align*}%
f(Aï¼Œ\bsmat{Ïƒ \\ u \\ v}) = \pmat{ Ïƒ - u^âŠ¤Av \\ ÏƒÂ²u - ÏƒAv \\ ÏƒÂ²v - ÏƒA^âŠ¤u} â‰¡ ğŸ%
âŸ¹ ğ‰_f(Aï¼Œ\bsmat{Ïƒ \\ u \\ v}) = \barr{c|ccc}{-Î¾vu^âŠ¤ & 1 & 2Ïƒu - Av & 2Ïƒv - A^âŠ¤u \\ -ÏƒvÏ•^âŠ¤ & -Av & ÏƒÂ²ğ•€â‚˜  & -ÏƒA \\ -ÏƒuÏˆ^âŠ¤ & -A^âŠ¤u & -ÏƒA^âŠ¤ & ÏƒÂ²ğ•€â‚™ }
\end{align*}%
%
Thus, gradient descent schema is

%
\begin{align*}%
\begin{aligned}
Ïƒ' &= Ïƒ - Î·_Ïƒ(Ïƒ - u^âŠ¤Av) \\
u' &= u - Î·_u(ÏƒÂ²u - ÏƒAv) \\
v' &= v - Î·_v(ÏƒÂ²v - ÏƒA^âŠ¤u)
\end{aligned}
\end{align*}%
%
And the newton step with diagonal approximation of the hessian:
%
\begin{align*}%
\begin{aligned}
Ïƒ' &= Ïƒ - 1(Ïƒ - u^âŠ¤Av)              &&= u^âŠ¤Av \\
u' &= u - \tfrac{1}{ÏƒÂ²}(ÏƒÂ²u - ÏƒAv)  &&= \tfrac{1}{Ïƒ}Av \\
v' &= v - \tfrac{1}{ÏƒÂ²}(ÏƒÂ²v - ÏƒA^âŠ¤u)&&= \tfrac{1}{Ïƒ}A^âŠ¤u
\end{aligned}
\end{align*}%
%





%
\begin{align*}%
	Ïƒ &= u^âŠ¤ A v
\\  Av &= Ïƒu
\\  A^âŠ¤u &= Ïƒv%
\end{align*}%
%
from this we can derive
%
\begin{align*}%
âˆ†Ïƒ &= {âˆ†u}^âŠ¤ A v + u^âŠ¤{âˆ†A}v + u^âŠ¤A{âˆ†v}
\\ &= {âˆ†u}^âŠ¤u + u^âŠ¤{âˆ†A}v + v^âŠ¤{âˆ†v}
\\ &= u^âŠ¤{âˆ†A}v%
\end{align*}%
%
Where in the last step we used $âˆ†uâŸ‚u$ and $âˆ†vâŸ‚v$, which follows from the side condition. Further we have:
%
\begin{align*}%
\begin{aligned}
   {âˆ†A}v  + A{âˆ†v} &= {âˆ†Ïƒ}u + Ïƒ{âˆ†u}
\\ {âˆ†A}^âŠ¤u + A^âŠ¤{âˆ†u} &= {âˆ†Ïƒ}v + Ïƒ{âˆ†v}%
\end{aligned}
\iff
\underbrace{\bmat[c]{Ïƒğ•€â‚˜ & -A \\ -A^âŠ¤ & Ïƒğ•€â‚™}}_{â‰•K}â‹…\bmat{âˆ†u\\âˆ†v} = \bmat{{âˆ†A}v - {âˆ†Ïƒ}u \\ {âˆ†A}^âŠ¤u - {âˆ†Ïƒ}v}
\end{align*}%
%
\section{The VJP}
The last equation allows us to compute the VJP at ease:
%
\begin{align*}%
\Bigl{âŸ¨}\bmat{Ï•\\Ïˆ}\Bigm{\vert}\bmat{âˆ†u\\âˆ†v}\Bigr{âŸ©}
&= \Bigl{âŸ¨}\bmat{Ï•\\Ïˆ}\Bigm{\vert} K^{-1}\bmat{{âˆ†A}v - {âˆ†Ïƒ}u \\ {âˆ†A}^âŠ¤u - {âˆ†Ïƒ}v}\Bigr{âŸ©}
\\&= \Bigl{âŸ¨}K^{-âŠ¤}\bmat{Ï•\\Ïˆ}\Bigm{\vert}\bmat{{âˆ†A}v - {âˆ†Ïƒ}u \\ {âˆ†A}^âŠ¤u - {âˆ†Ïƒ}v}\Bigr{âŸ©}%
\\&= \Bigl{âŸ¨}\bmat{\tilde{Ï•}\\\tilde{Ïˆ}}\Bigm{\vert}\bmat{{âˆ†A}v - {âˆ†Ïƒ}u \\ {âˆ†A}^âŠ¤u - {âˆ†Ïƒ}v}\Bigr{âŸ©}%
\end{align*}%
%
Now, we compute the terms individually:
%
\begin{align*}%
âŸ¨\tilde{Ï•}âˆ£ {âˆ†A}v - {âˆ†Ïƒ}uâŸ©
&= âŸ¨\tilde{Ï•}v^âŠ¤âˆ£ {âˆ†A}âŸ© - âŸ¨u^âŠ¤\tilde{Ï•}âˆ£{âˆ†Ïƒ}âŸ©%
\\&= âŸ¨\tilde{Ï•}v^âŠ¤âˆ£ {âˆ†A}âŸ© - âŸ¨u^âŠ¤\tilde{Ï•}âˆ£u^âŠ¤{âˆ†A}vâŸ©%
\\&= âŸ¨(ğ•€â‚˜ - uu^âŠ¤)\tilde{Ï•}v^âŠ¤âˆ£{âˆ†A}âŸ©
\end{align*}%
%
And for the second term we get
%
\begin{align*}%
âŸ¨\tilde{Ïˆ} âˆ£ {âˆ†A}^âŠ¤ u - {âˆ†Ïƒ}vâŸ©
&= âŸ¨\tilde{Ïˆ}u^âŠ¤âˆ£ {âˆ†A}^âŠ¤âŸ© - âŸ¨v^âŠ¤\tilde{Ïˆ}âˆ£{âˆ†Ïƒ}âŸ©%
\\&= âŸ¨u\tilde{Ïˆ}^âŠ¤âˆ£ {âˆ†A}âŸ© - âŸ¨\tilde{Ïˆ}^âŠ¤vâˆ£u^âŠ¤{âˆ†A}vâŸ©%
\\&= âŸ¨u\tilde{Ïˆ}(ğ•€â‚™ - vv^âŠ¤)âˆ£{âˆ†A}âŸ©
\end{align*}%
%
Using the formula for inverting a block-matrix, we can give an explicit solution to $K^{-âŠ¤}$:
%
\begin{align*}%
\bmat[c]{Ïƒğ•€â‚˜ & -A \\ -A^âŠ¤ & Ïƒğ•€â‚™}^{-1}
&= \bmat{(Ïƒğ•€â‚˜ - \frac{1}{Ïƒ}AA^âŠ¤)^{-1} & ğŸ_{mÃ—n} \\ ğŸ_{nÃ—m} & (Ïƒğ•€â‚™ - \frac{1}{Ïƒ}A^âŠ¤A)^{-1}}â‹…\bmat{ğ•€â‚˜ & \frac{1}{Ïƒ}A \\ \frac{1}{Ïƒ}A^âŠ¤ & ğ•€â‚™}%
\\&= \bmat{\tfrac{1}{Ïƒ}(ğ•€â‚˜ - \frac{1}{ÏƒÂ²}AA^âŠ¤)^{-1} & \tfrac{1}{ÏƒÂ²}(ğ•€â‚˜ - \frac{1}{ÏƒÂ²}AA^âŠ¤)^{-1}A \\ \frac{1}{ÏƒÂ²}(ğ•€â‚™ - \frac{1}{ÏƒÂ²}A^âŠ¤A)^{-1}A^âŠ¤ & \tfrac{1}{Ïƒ}(ğ•€â‚™ - \frac{1}{ÏƒÂ²}A^âŠ¤A)^{-1} }
\\&= \frac{1}{Ïƒ}\bmat{(ğ•€â‚˜ - \tilde{A}\tilde{A}^âŠ¤)^{-1} & (ğ•€â‚˜ - \tilde{A}\tilde{A}^âŠ¤)^{-1}\tilde{A} \\ (ğ•€â‚™ - \tilde{A}^âŠ¤\tilde{A})^{-1}\tilde{A}^âŠ¤ & (ğ•€â‚™ - \tilde{A}^âŠ¤\tilde{A})^{-1} }
\end{align*}%
%
And we see it's basically projection operators with respect to the image/kernel of $\tilde{A} = \frac{1}{Ïƒ}A$.
%
In summary, we obtain the following formula for the VJP:

%
\begin{align*}%
\bmat[c]{Ïƒğ•€â‚˜ & -A \\ -A^âŠ¤ & Ïƒğ•€â‚™}^âŠ¤\bmat{\tilde{Ï•}\\Â \tilde{Ïˆ}} = \bmat{Ï•\\Ïˆ}
&âŸº
\bmat{\tilde{Ï•}\\Â \tilde{Ïˆ}} = \frac{1}{Ïƒ}\bmat{
		(ğ•€â‚˜ - \tilde{A}\tilde{A}^âŠ¤)^{-1} & (ğ•€â‚˜ - \tilde{A}\tilde{A}^âŠ¤)^{-1}\tilde{A}
	\\  (ğ•€â‚™ - \tilde{A}^âŠ¤\tilde{A})^{-1}\tilde{A}^âŠ¤ & (ğ•€â‚™ - \tilde{A}^âŠ¤\tilde{A})^{-1}
}^âŠ¤ \bmat{Ï•\\Ïˆ}%
\\&âŸº
\bmat{\tilde{Ï•}\\Â \tilde{Ïˆ}} = \frac{1}{Ïƒ}\bmat{
		(ğ•€â‚˜ - \tilde{A}\tilde{A}^âŠ¤)^{-1} & \tilde{A}(ğ•€â‚™ - \tilde{A}^âŠ¤\tilde{A})^{-1}
	\\  \tilde{A}^âŠ¤(ğ•€â‚˜ - \tilde{A}\tilde{A}^âŠ¤)^{-1}  & (ğ•€â‚™ - \tilde{A}^âŠ¤\tilde{A})^{-1}
} \bmat{Ï•\\Ïˆ}%
\end{align*}%
%
We can use the \textbf{push-through identity} to convert these into 4 linear systems:
%
\begin{align*}%
	(ğ•€â‚˜ - \tilde{A}\tilde{A}^âŠ¤)x &= Ï•             & (ğ•€â‚˜ - \tilde{A}\tilde{A}^âŠ¤)y &= \tilde{A}Ïˆ%
\\  (ğ•€â‚™ - \tilde{A}^âŠ¤\tilde{A})z &= \tilde{A}^âŠ¤Ï•  & (ğ•€â‚™ - \tilde{A}^âŠ¤\tilde{A})w &= Ïˆ
\end{align*}%
%
%
We can use the \textbf{push-through identity} to convert these into 4 linear systems:
%
\begin{align*}%
	Px &= Ï•             & Py &= \tilde{A}Ïˆ%
\\  Qz &= \tilde{A}^âŠ¤Ï•  & Qw &= Ïˆ
\end{align*}%
%
Then $\tilde{Ï•} = \frac{1}{Ïƒ}(x+y)$ and $\tilde{Ïˆ} = \frac{1}{Ïƒ}(z+w)$, and the VJP are given by the previous equations:
%
\begin{align*}%
	Î¾^âŠ¤\frac{âˆ‚Ïƒ}{âˆ‚A} &= Î¾uv^âŠ¤
\\  Ï•^âŠ¤\frac{âˆ‚u}{âˆ‚A} &= (ğ•€â‚˜ - uu^âŠ¤)\tilde{Ï•}v^âŠ¤ = (\tilde{Ï•} - (u^âŠ¤\tilde{Ï•})u)v^âŠ¤%
\\  Ïˆ^âŠ¤\frac{âˆ‚v}{âˆ‚A} &= u\tilde{Ïˆ}^âŠ¤(ğ•€â‚™ - vv^âŠ¤) = u(\tilde{Ïˆ} - (v^âŠ¤\tilde{Ïˆ})v)^âŠ¤%
\end{align*}%
%
\end{document}
